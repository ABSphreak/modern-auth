<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>MODERN AUTH</title>
	</head>
	<body>
		<div>
			<h3>Register Form</h3>
			<form id="registeration-form">
				<input type="email" name="email" />
				<input type="password" name="password" />
				<button type="submit">Register</button>
			</form>
		</div>

		<br />
		<hr />
		<br />

		<div>
			<h3>Login Form</h3>
			<form id="login-form">
				<input type="email" name="email" />
				<input type="password" name="password" />
				<button>Sign in</button>
			</form>
		</div>

		<br />
		<hr />
		<br />

		<div><button onclick="logout()">Logout</button></div>

		<br />
		<hr />
		<br />

		<div>
			<h3>Change Password</h3>
			<form id="change-form">
				<label for="oldPassword">Old Password</label>
				<input type="password" name="oldPassword" />
				<label for="newPassword">New Password</label>
				<input type="password" name="newPassword" />
				<button>Change Password</button>
			</form>
		</div>

		<script>
			const API_URL = 'https://api.nodeauth.dev';
			async function logout() {
				try {
					console.log('LOGOUT_RAN');
					const res = await fetch(`${API_URL}/api/logout`, {
						method: 'POST',
						credentials: 'include',
					});
				} catch (e) {
					console.error(e);
				}
			}

			(() => {
				// Grabbing forms
				const registerForm = document.getElementById('registeration-form');
				const loginForm = document.getElementById('login-form');
				const changeForm = document.getElementById('change-form');

				// Register form logic
				registerForm.addEventListener('submit', async e => {
					try {
						e.preventDefault();
						const values = Object.values(registerForm).reduce((obj, field) => {
							if (field.name) {
								obj[field.name] = field.value;
							}
							return obj;
						}, {});
						const res = await fetch(`${API_URL}/api/register`, {
							method: 'POST',
							body: JSON.stringify(values),
							credentials: 'include',
							headers: { 'Content-type': 'application/json; charset=UTF-8' },
						});
					} catch (e) {
						console.error(e);
					}
				});

				// Login form logic
				loginForm.addEventListener('submit', async e => {
					try {
						e.preventDefault();
						const values = Object.values(loginForm).reduce((obj, field) => {
							if (field.name) {
								obj[field.name] = field.value;
							}
							return obj;
						}, {});
						const res = await fetch(`${API_URL}/api/authorize`, {
							method: 'POST',
							body: JSON.stringify(values),
							credentials: 'include',
							headers: { 'Content-type': 'application/json; charset=UTF-8' },
						});
					} catch (e) {
						console.error(e);
					}
				});

				// Change Password form logic
				changeForm.addEventListener('submit', async e => {
					try {
						e.preventDefault();
						const values = Object.values(changeForm).reduce((obj, field) => {
							if (field.name) {
								obj[field.name] = field.value;
							}
							return obj;
						}, {});
						const res = await fetch(`${API_URL}/api/change-password`, {
							method: 'POST',
							body: JSON.stringify(values),
							credentials: 'include',
							headers: { 'Content-type': 'application/json; charset=UTF-8' },
						});
					} catch (e) {
						console.error(e);
					}
				});
			})();
		</script>
	</body>
</html>
